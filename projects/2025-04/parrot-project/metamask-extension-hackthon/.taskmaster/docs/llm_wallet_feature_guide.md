# 通用钱包 LLM 交易分析功能 - PRD 与实现指南

本文档旨在为在任何开源钱包项目中实现"LLM交易分析"功能提供一套标准的、可复用的产品需求和AI实现指南。

---

## 第一部分：产品需求文档 (PRD)

*此部分可直接复制并交给 Taskmaster AI 进行项目初始化和任务生成。*

### 1. 功能概述 (Objective)
为交易确认流程集成一个由大语言模型（LLM）驱动的分析功能。该功能旨在将复杂的交易数据转换为易于理解的自然语言摘要，并向用户提示潜在风险，帮助用户做出更明智的决策。

### 2. 用户流程 (User Flow)
1.  用户在钱包中发起一笔交易（如发送代币、与合约交互等）。
2.  钱包弹出交易确认界面，展示标准的交易细节。
3.  在该界面上，用户会看到一个"AI 安全分析"按钮。
4.  用户点击该按钮，按钮进入"分析中..."的加载状态。
5.  钱包在后台准备交易数据，调用指定的LLM API进行分析。此过程不应阻塞用户正常的"确认"或"拒绝"操作。
6.  LLM API 返回分析结果后，加载状态结束。
7.  分析结果（包括风险等级和文字摘要）清晰地展示在按钮下方。如果分析失败，则显示相应的错误信息。

### 3. 功能需求 (Functional Requirements)

#### 3.1. UI 组件
- **分析触发器**: 一个独立的React组件 (`AnalysisButton.tsx`)，负责处理点击事件和显示加载状态。
- **结果展示**: 一个独立的React组件 (`AnalysisResult.tsx`)，负责根据传入的 props（分析内容、风险等级）来渲染不同的UI样式（例如，高风险用红色突出显示）。

#### 3.2. 数据处理
- **交易数据格式化**: 需要一个独立的工具函数 (`formatTransactionForLLM.ts`)，其职责是接收钱包内部的交易对象 (`transaction` 或 `confirmation` 对象)，并将其转换为一个结构化、扁平化的JSON对象，以便发送给LLM。

#### 3.3. API 服务
- **LLM服务层**: 需要一个专门的`LlmAnalysisService.ts`类，用于封装所有与LLM API的交互逻辑。
  - 构造函数应能接收 `apiKey`, `model`, 和 `apiUrl`。
  - 核心方法 `analyzeTransaction(data)` 接收格式化后的交易数据，并返回一个Promise，该Promise在成功时解析为包含分析结果的对象。
- **LLM Prompt 设计**: 发送给LLM的Prompt必须明确指示其扮演"区块链安全专家"的角色，并要求它以**纯净的JSON格式**返回结果。
- **API 响应契约 (JSON)**: LLM必须返回一个包含以下两个键的JSON对象：
  - `analysis`: (string) 对交易的自然语言摘要和风险解释。
  - `riskLevel`: (string) "low", "medium", 或 "high" 其中之一。

### 4. 非功能需求 (Non-Functional Requirements)
- **异步执行**: LLM分析必须是异步的，不能阻塞UI线程或用户的主要操作路径。
- **配置管理**: API密钥和模型名称等配置应易于管理，避免在最终产品中硬编码。

### 5. 初始版本范围 (Out of Scope for PoC)
- 分析结果的缓存。
- 复杂的UI动画和交互。
- 用户反馈机制。

---

## 第二部分：给 Taskmaster AI 的实现指南

*这是给AI的元指令，帮助你更高效、更准确地完成任务。在开始项目时，请先阅读并理解这些指南。*

### 1. 任务生成建议
使用上述PRD进行任务解析时，建议生成 **10到15个任务** (`--num-tasks=12`)。这能确保任务粒度适中，既能覆盖所有环节，又不会过于琐碎。

### 2. 核心实现步骤与提示

**在你开始编码前，请务必遵循以下建议，这将帮你规避我们已知的所有陷阱。**

1.  **任务1: 代码库勘探**:
    - **目标**: 找到交易确认页面的核心UI组件。这是所有后续工作的基础。
    - **行动**: 仔细搜索 `confirm`, `transaction`, `approval` 等关键词。不要满足于找到的第一个文件，要理解组件的嵌套和路由关系，定位到最终渲染交易详情的那个文件。

2.  **任务2: 占位符UI集成**:
    - **目标**: 快速验证集成点是否正确。
    - **行动**: 不要一开始就实现完整功能。先创建两个最简单的占位符组件 (`AnalysisButton.tsx` 和 `AnalysisResult.tsx`)，让它们只显示静态文本。然后将它们集成到你在任务1中找到的核心UI文件里，确保它们能正常显示。

3.  **任务3: 数据格式化函数的实现与调试**:
    - **目标**: 实现 `formatTransactionForLLM` 函数。
    - **行动**:
        - **关键陷阱**: 钱包内部的交易对象类型复杂，**很多字段是可选的**。在定义你的TypeScript接口时，务必为所有可能不存在的字段（特别是 `tx.value`）加上 `?`，例如 `value?: string`。
        - **调试技巧**: 在函数中大量使用 `console.log` 打印传入的原始交易对象和函数返回的对象，确保格式化逻辑正确无误。

4.  **任务4: API服务层的实现**:
    - **目标**: 实现 `LlmAnalysisService.ts`。
    - **行动**:
        - **关键陷阱**: LLM经常以Markdown代码块的形式返回JSON。**请直接在 `parseResponse` 方法中内置一个正则表达式来提取JSON内容**。不要等待错误出现后再修复。使用这个正则：` / \`\`\`json\s*([\s\S]*?)\s*\`\`\` / `。
        - **模块导出**: 始终使用 **命名导出** (`export class ...`)，不要使用默认导出 (`export default ...`)。

5.  **任务5: 端到端功能联调**:
    - **目标**: 将所有部分连接起来，实现完整功能。
    - **行动**:
        - **关键陷阱**: 当你从UI组件中导入服务类时，**必须使用命名导入** (`import { LlmTransactionAnalysisService } from ...`)。如果你使用了默认导入，100%会遇到 `is not a constructor` 的致命错误。
        - **状态管理**: 使用 `useState` 来管理UI的 `isLoading`, `error`, `result` 等状态。

### 3. 推荐的工作流程
1.  **解析PRD生成任务**。
2.  严格按照上述 **实现步骤与提示** 的顺序执行任务。
3.  **优先解决已知陷阱**。在编写代码时，就直接规避掉 "模块导入"、"可选类型" 和 "JSON解析" 这三个我们已经知道的问题。
4.  每个任务完成后，进行**小范围的手动测试**，确保当前部分工作正常，再进入下一个任务。
5.  所有功能完成后，编写单元测试和端到端（E2E）测试。