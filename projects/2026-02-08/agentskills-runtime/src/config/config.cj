/*
 * Copyright (c) Huawei Technologies Co., Ltd. 2024-2025. All rights reserved.
 */
package magic.config

import magic.core.model.{ChatModel, EmbeddingModel}
import magic.core.tokenizer.Tokenizer
import magic.utils.{exists, setEnv, getEnv}

import std.unicode.UnicodeStringExtension
import std.fs.{File, Path}
import std.regex.Regex

/**
 * Wrapper for providing a convenient way to get and set environment variables.
 */
public struct EnvWrapper {
    public operator func [](name: String): Option<String> {
        return getEnv(name)
    }

    public operator func [](name: String, value!: String): Unit {
        return setEnv(name, value)
    }

    /**
     * Load the environment variables from a .env file.
     */
    public func load(path: Path): String {
        if (!exists(path)) {
            return "${path} does not exist"
        }
        let strBuilder = StringBuilder()
        try {
            let content = String.fromUtf8(File.readFrom(path))
            // A simple regex to match key-value pairs in the .env file
            let regex = Regex("^\\s*([\\w.]+)\\s*=\\s*(\"[^\"]*\"|'[^']*'|[^#]*)\\s*(?:#.*)?$")
            for (line in content.split("\n")) {
                if (let Some(md) <- regex.find(line, group: true)) {
                    let key = md.matchString(1).trimAscii()
                    var value = md.matchString(2).trimAscii()
                    // strip quote marks if necessary
                    if (value.startsWith('"')) {
                        value = value.replace('"', "")
                    } else if (value.startsWith("'")) {
                        value = value.replace("'", "")
                    }
                    strBuilder.append("[ENV Set] ${key}=${value}\n")
                    setEnv(key, value)
                }
            }
        } catch (e: Exception) {
            strBuilder.append("Failed to read .env file")
        }
        return strBuilder.toString()
    }
}

public class Config {
    /**
     * To avoid introducing a dependency on the stdx.log.LogLevel type, we use the String type.
     * The optional values are "error", "info", and "debug"; case-insensitive.
     */
    private static var _logLevel = "error"
    private static var VALID_LOG_LEVELS = ["error", "info", "debug", "trace"]

    /**
     * Available log levels:
     * "error", "info", "debug", "trace"
     */
    public static mut prop logLevel: String {
        get() { _logLevel }
        set(v) {
            if (!VALID_LOG_LEVELS.contains(v.toAsciiLower())) {
                eprintln("Invalid log level ${v}")
            } else {
                _logLevel = v.toAsciiLower()
            }
        }
    }

    /**
     * File used to save logs.
     * If set to "stderr", logs will be printed to standard error.
     * If set to a file path, logs will be saved to that file.
     */
    public static var logFile: String = "stderr"

    /**
     * Whether to enable agent log.
     * If enabled, agent logs will be saved to the separate files.
     */
    public static var enableAgentLog = false

    /**
     * Directory used to save agent logs.
     */
    public static var agentLogDir = "./logs/agent-logs"

    /**
     * Whether to save model requests.
     */
    public static var saveModelRequest = false

    /**
     * Directory used to save model requests.
     */
    public static var modelRequestDir = "./logs/model-requests"

    /**
     * Whether to save code interpreter scripts generated by code interpreter tools.
     */
    public static var saveCodeInterpreter = false

    /**
     * Directory used to save scripts generated by code interpreter tools.
     */
    public static var codeInterpreterDir = "./logs/code-interpreter-scripts"

    /**
     * Default chat model and embedding model.
     */
    public static var defaultChatModel = Option<ChatModel>.None
    public static var defaultEmbeddingModel = Option<EmbeddingModel>.None

    /**
     * Default tokenizer and context length.
     */
    public static var defaultTokenizer = Option<Tokenizer>.None
    public static var defaultContextLen = 32000

    /**
     * Directory for resources
     */
    private static var _resourceDir = "./resource"
    public static mut prop resourceDir: String {
        get() {
            if (!exists(_resourceDir)) {
                throw UnsupportedException("Resource dir is not set.")
            }
            return _resourceDir
        }
        set(value) {
            _resourceDir = value
        }
    }

    /**
     * The max retry number when failing to valid get LLM responses
     */
    public static var modelRetryNumber = 3

    /**
     * Whether filter <think> messages generated by reasoning LLMs
     * Only takes effect under synchronous call
     */
    // public static var filterThink = false

    /**
     * Whether to use the tool call feature of LLMs.
     * This option is used in "tool-loop", "dsl" and "react" executor.
     */
    public static var enableModelToolCall = false

    /**
     * Whether to enable parallel tool call feature of LLMs.
     * This option is used in "tool-loop", "dsl" and "react" executor.
     */
    public static var enableParallelToolCall = true

    /**
     * Whether to enable tool call check, like checking repeated tool calls
     */
    public static var enableToolCallCheck = false

    /**
     * Whether to enable json repair when the model response is not valid json.
     */
    public static var enableJsonRepair = true

    /**
     * Control the max output token of models.
     * See model provider API doc for details.
     */
    // public static var modelMaxTokens: Option<Int64> = None
    // public static var modelMaxCompletionTokens: Option<Int64> = None

    /**
     * The threshold to decide whether to summarize the tool result when the tool enables summarization.
     * The threshold is in byte size.
     */
    public static var toolResultCompactThreshold = 1500

    /**
     * Provide a way to easily get/set environment variables
     */
    public static let env = EnvWrapper()

    /**
     * The max number of react execution steps
     */
    public static var maxReactNumber = 10

    /**
     * The max retry number when failing to generate outputs of required json schema
     */
    public static var outputRepairRetryNumber = 3

    /**
     * The max connection timeout in http requests. MS
     */
     public static var httpConnectTimeout = 60000 // ms

    /**
     * The max read/write timeout in http requests. MS
     */
     public static var httpReadWriteTimeout = 60000 // ms

    /**
     * Import paths for file import functionality
     * Used to resolve @<path> references in agent requests
     * Default includes current directory "."
     */
    public static var importPaths = ["."]

    /**
     * Base URL for API requests
     */
    public static var BASE_URL: Option<String> = None

    /**
     * Register uncaught exception handler for threads spawn by `Agent.asyncChat`
     * A bug in Cangjie std.core.Thread?
     * If we use Thread.handleUncaughtExceptionBy outside this project,
     * it will not affect threads spawn in this project.
     */
    // private static var _threadExceptionHandler: Option<(Thread, Exception) -> Unit> = None
    // public static mut prop threadExceptionHandler: Option<(Thread, Exception) -> Unit> {
    //     get() { _threadExceptionHandler }
    //     set(handler) {
    //         if (let Some(h) <- handler) {
    //             Thread.handleUncaughtExceptionBy(h)
    //         }
    //     }
    // }
}
